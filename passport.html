<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake H·ªô Chi·∫øu - FakeBill</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõÇ</text></svg>">
</head>

<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Quay l·∫°i</a>

        <header class="header">
            <h1>üõÇ Fake H·ªô Chi·∫øu</h1>
            <p>T·∫°o h·ªô chi·∫øu Vi·ªát Nam</p>
        </header>

        <main class="fade-in">
            <!-- Form -->
            <div class="card">
                <div class="form-group">
                    <label>S·ªë h·ªô chi·∫øu</label>
                    <input type="text" class="form-input" id="passportNumber" placeholder="C1234567" value="C1234567"
                        maxlength="9">
                </div>
                <div class="form-group">
                    <label>H·ªç (Surname)</label>
                    <input type="text" class="form-input" id="surname" placeholder="NGUYEN" value="NGUYEN">
                </div>
                <div class="form-group">
                    <label>T√™n ƒë·ªám v√† t√™n (Given names)</label>
                    <input type="text" class="form-input" id="givenNames" placeholder="VAN A" value="VAN A">
                </div>
                <div class="form-group">
                    <label>Ng√†y sinh</label>
                    <input type="date" class="form-input" id="birthDate" value="1990-01-15">
                </div>
                <div class="form-group">
                    <label>Gi·ªõi t√≠nh</label>
                    <select class="form-input" id="gender">
                        <option value="M">Nam (M)</option>
                        <option value="F">N·ªØ (F)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>N∆°i sinh</label>
                    <input type="text" class="form-input" id="birthPlace" value="TP HO CHI MINH">
                </div>
                <div class="form-group">
                    <label>Ng√†y c·∫•p</label>
                    <input type="date" class="form-input" id="issueDate" value="2023-01-15">
                </div>
                <div class="form-group">
                    <label>Ng√†y h·∫øt h·∫°n</label>
                    <input type="date" class="form-input" id="expiryDate" value="2033-01-15">
                </div>
                <div class="form-group">
                    <label>·∫¢nh h·ªô chi·∫øu</label>
                    <input type="file" class="form-input" id="photoUpload" accept="image/*">
                </div>
            </div>

            <!-- Preview -->
            <div class="card">
                <h3 style="margin-bottom:16px; font-weight:600;">Xem tr∆∞·ªõc</h3>
                <div class="preview-area" id="previewArea">
                    <canvas id="passportCanvas" style="display:none; max-width:100%;"></canvas>
                    <div class="preview-placeholder" id="placeholder">
                        <span>üõÇ</span>
                        <p>Nh·∫•n "T·∫°o H·ªô Chi·∫øu" ƒë·ªÉ xem tr∆∞·ªõc</p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="generatePassport()">‚ú® T·∫°o H·ªô Chi·∫øu</button>
                <button class="btn btn-success" onclick="downloadPassport()" id="downloadBtn" disabled>üì• T·∫£i
                    ·∫¢nh</button>
            </div>
        </main>

        <footer class="footer">
            <p><a href="https://github.com/chumvn/fakebill" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <script>
        let photoDataUrl = null;
        let generatedCanvas = null;

        // Template positions for passport text overlay
        const passportTemplate = {
            src: 'assets/templates/passport.png',
            positions: {
                passportNumber: { x: 350, y: 280, fontSize: 28, color: '#000', font: 'bold' },
                surname: { x: 350, y: 350, fontSize: 22, color: '#000' },
                givenNames: { x: 350, y: 410, fontSize: 22, color: '#000' },
                birthDate: { x: 350, y: 470, fontSize: 20, color: '#000' },
                gender: { x: 350, y: 520, fontSize: 20, color: '#000' },
                birthPlace: { x: 350, y: 570, fontSize: 18, color: '#000' },
                issueDate: { x: 350, y: 620, fontSize: 18, color: '#000' },
                expiryDate: { x: 350, y: 670, fontSize: 18, color: '#000' },
                photo: { x: 100, y: 300, width: 200, height: 260 },
                mrz: { x: 50, y: 800, fontSize: 16, color: '#000' }
            }
        };

        document.getElementById('photoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    photoDataUrl = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        function formatMrzDate(dateStr) {
            const date = new Date(dateStr);
            const y = date.getFullYear().toString().slice(-2);
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return y + m + d;
        }

        function padRight(str, len) {
            return (str + '<'.repeat(len)).slice(0, len);
        }

        async function generatePassport() {
            const canvas = document.getElementById('passportCanvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.crossOrigin = 'anonymous';

            return new Promise((resolve, reject) => {
                img.onload = async () => {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // Draw template
                    ctx.drawImage(img, 0, 0);

                    const pos = passportTemplate.positions;

                    // Draw photo if uploaded
                    if (photoDataUrl) {
                        const photoImg = new Image();
                        photoImg.onload = () => {
                            ctx.drawImage(photoImg, pos.photo.x, pos.photo.y, pos.photo.width, pos.photo.height);
                            drawPassportText(ctx, pos);
                        };
                        photoImg.src = photoDataUrl;
                    } else {
                        drawPassportText(ctx, pos);
                    }

                    document.getElementById('placeholder').style.display = 'none';
                    canvas.style.display = 'block';
                    document.getElementById('downloadBtn').disabled = false;
                    generatedCanvas = canvas;
                    resolve();
                };

                img.onerror = () => {
                    alert('Kh√¥ng th·ªÉ t·∫£i template. Vui l√≤ng th·ª≠ l·∫°i.');
                    reject();
                };

                img.src = passportTemplate.src;
            });
        }

        function drawPassportText(ctx, pos) {
            const passportNum = document.getElementById('passportNumber').value.toUpperCase();
            const surname = document.getElementById('surname').value.toUpperCase();
            const given = document.getElementById('givenNames').value.toUpperCase();
            const dob = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const place = document.getElementById('birthPlace').value.toUpperCase();
            const issue = document.getElementById('issueDate').value;
            const expiry = document.getElementById('expiryDate').value;

            // Passport number
            ctx.font = `${pos.passportNumber.font} ${pos.passportNumber.fontSize}px 'Courier New', monospace`;
            ctx.fillStyle = pos.passportNumber.color;
            ctx.fillText(passportNum, pos.passportNumber.x, pos.passportNumber.y);

            // Surname
            ctx.font = `${pos.surname.fontSize}px Arial`;
            ctx.fillText(surname, pos.surname.x, pos.surname.y);

            // Given names
            ctx.fillText(given, pos.givenNames.x, pos.givenNames.y);

            // Birth date
            ctx.font = `${pos.birthDate.fontSize}px Arial`;
            ctx.fillText(formatDate(dob), pos.birthDate.x, pos.birthDate.y);

            // Gender
            ctx.fillText(gender, pos.gender.x, pos.gender.y);

            // Birth place
            ctx.font = `${pos.birthPlace.fontSize}px Arial`;
            ctx.fillText(place, pos.birthPlace.x, pos.birthPlace.y);

            // Issue date
            ctx.fillText(formatDate(issue), pos.issueDate.x, pos.issueDate.y);

            // Expiry date
            ctx.fillText(formatDate(expiry), pos.expiryDate.x, pos.expiryDate.y);

            // Generate MRZ
            const surnameClean = surname.replace(/ /g, '<');
            const givenClean = given.replace(/ /g, '<');
            const line1 = 'P<VNM' + padRight(surnameClean + '<<' + givenClean, 39);
            const line2 = padRight(passportNum, 9) + '0VNM' + formatMrzDate(dob) + gender + formatMrzDate(expiry) + padRight('', 14) + '0';

            ctx.font = `${pos.mrz.fontSize}px 'Courier New', monospace`;
            ctx.fillStyle = pos.mrz.color;
            ctx.fillText(line1, pos.mrz.x, pos.mrz.y);
            ctx.fillText(line2, pos.mrz.x, pos.mrz.y + 22);
        }

        function downloadPassport() {
            if (!generatedCanvas) return;

            const link = document.createElement('a');
            link.download = `passport_${Date.now()}.png`;
            link.href = generatedCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>

</html>